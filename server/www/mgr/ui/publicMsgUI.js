uiMgr.addUI
(
	"publicMsgUI",
	function()//初始化
	{
		publicMsgUI=new PublicMsgUI();
		$("#publicMsgUI_queryBtn").click(function(){
			//刷新订单列表
			publicMsgUI.resetPage();
			publicMsgUI.reqPage();
		});
		$("#publicMsgUI_listView").scroll(function(){
			var pos=$(this).height()+this.scrollTop;
			var maxPos=this.scrollHeight;
			if(pos>=(maxPos-50))
			{
				orderUI.reqPage();
			}
		});
		$("#publicMsgUI_addBtn").click(function(){
			$("#addPublicMsgUI").modal('open');
		});
		$("#addPublicMsgUI_saveBtn").click(function(){
			publicMsgUI.add();
		});
		$("#editPublicMsgUI_saveBtn").click(function(){
			publicMsgUI.save();
		});
		$("#publicMsgUI_editGlobalBtn").click(function(){
			publicMsgUI.editGlobal();
		});
		$("#editGlobalPublicMsgUI_saveBtn").click(function(){
			publicMsgUI.saveGlobal();
		});
	},
	function()//显示
	{
		//刷新订单列表
		publicMsgUI.resetPage();
		publicMsgUI.reqPage();
	}
);

PublicMsgUI=function()
{
	var that=this;
	var page=0;
	var isPageEnd=false;
	var isReqPage=false;
	this.publicMsgID=0;
	//请求页
	this.resetPage=function()
	{
		page=0;
		isPageEnd=false;
	}
	//刷新公告列表
	this.reqPage=function()
	{
		if(isReqPage)return;
		if(isPageEnd)return;
		isReqPage=true;
		reqJson
		(
			"post",
			redirectCurServer("web_api/publicMsg.php"),
			{
				action:'list',
				userID:cache.get('userID'),
				tick:cache.get('tick'),
				page:page,
			},
			function(json)
			{
				isReqPage=false;
				if(json.result==1)
				{
					if(json.data.length>0)
					{
						if(page==0)
						{
							$("#publicMsgUI_listView").html('<table></table>');
							$("#publicMsgUI_listView table").append("<tr><td>ID</td><td>标题</td><td>创建日期</td><td>操作</td></tr>");
							$("#publicMsgUI_listView")[0].scrollTop=0;
						}
						++page;
						var list=json.data;
						for(var i=0;i<list.length;++i)
						{
							var info=list[i];
							var str='<tr>';
							str+='<td>'+info.id+'</td>';
							str+='<td>'+info.title+'</td>';
							str+='<td>'+info.genTime+'</td>';
							str+='<td>';
							str+="<button onclick='publicMsgUI.edit("+info.id+");'>编辑</button>";
							str+="<button onclick='publicMsgUI.del("+info.id+");'>删除</button>";
							str+='</td>';
							str+='</tr>';
							$("#publicMsgUI_listView table").append(str);
						}
					}
					else
					{
						if(page==0)
						{
							$("#publicMsgUI_listView").html('无公告数据');
						}
						isPageEnd=true;
					}
					//console.log(json);
				}
			}
		);
	}
	//添加公告
	this.add=function(num)
	{
		reqJson
		(
			"post",
			redirectCurServer("web_api/publicMsg.php"),
			{
				action:'add',
				userID:cache.get('userID'),
				tick:cache.get('tick'),
				title:$("#addPublicMsgUI_title").val(),
				body:$("#addPublicMsgUI_body").val(),
			},
			function(json)
			{
				if(json.result==1)//成功
				{
					$("#addPublicMsgUI").modal('close');
					myAlert("添加成功");
					//刷新订单列表
					publicMsgUI.resetPage();
					publicMsgUI.reqPage();
				}
				else
				{
					$("#addPublicMsgUI").modal('close');
					myAlert("添加失败，已达最大数量");
				}
			}
		);
	}
	//编辑公告
	this.edit=function(publicMsgID)
	{
		this.publicMsgID=publicMsgID;
		reqJson
		(
			"post",
			redirectCurServer("web_api/publicMsg.php"),
			{
				action:'get',
				userID:cache.get('userID'),
				tick:cache.get('tick'),
				publicMsgID:this.publicMsgID,
			},
			function(json)
			{
				if(json.result==1)//成功
				{
					$("#editPublicMsgUI_title").val(json.title);
					$("#editPublicMsgUI_body").val(json.body);
					$("#editPublicMsgUI").modal('open');
				}
				else//公告不存在
				{
					//刷新订单列表
					publicMsgUI.resetPage();
					publicMsgUI.reqPage();
				}
			}
		);
	}
	//保存公告
	this.save=function()
	{
		reqJson
		(
			"post",
			redirectCurServer("web_api/publicMsg.php"),
			{
				action:'save',
				userID:cache.get('userID'),
				tick:cache.get('tick'),
				publicMsgID:this.publicMsgID,
				title:$("#editPublicMsgUI_title").val(),
				body:$("#editPublicMsgUI_body").val(),
			},
			function(json)
			{
				if(json.result==1)//成功
				{
					$("#editPublicMsgUI").modal('close');
					myAlert("保存成功");
					//刷新订单列表
					publicMsgUI.resetPage();
					publicMsgUI.reqPage();
				}
			}
		);
	}
	//删除公告
	this.del=function(publicMsgID)
	{
		this.publicMsgID=publicMsgID;
		$("#publicMsgUI_removeUI").modal({
			relatedTarget:this,
			onConfirm: function(options)
			{
				reqJson
				(
					"post",
					redirectCurServer("web_api/publicMsg.php"),
					{
						action:'del',
						userID:cache.get('userID'),
						tick:cache.get('tick'),
						publicMsgID:that.publicMsgID,
					},
					function(json)
					{
						if(json.result==1)//成功
						{
							myAlert("删除成功");
							//刷新订单列表
							publicMsgUI.resetPage();
							publicMsgUI.reqPage();
						}
					}
				);
			}
		});
	}
	
	//编辑全局公告
	this.editGlobal=function(publicMsgID)
	{
		this.publicMsgID=publicMsgID;
		reqJson
		(
			"post",
			"web_api/publicMsg.php",
			{
				action:'getGlobal',
				userID:cache.get('userID'),
				tick:cache.get('tick'),
				publicMsgID:this.publicMsgID,
			},
			function(json)
			{
				if(json.result==1)//成功
				{
					$("#editGlobalPublicMsgUI_body").val(json.body);
					$("#editGlobalPublicMsgUI").modal('open');
				}
			}
		);
	}
	//保存全局公告
	this.saveGlobal=function()
	{
		reqJson
		(
			"post",
			"web_api/publicMsg.php",
			{
				action:'saveGlobal',
				userID:cache.get('userID'),
				tick:cache.get('tick'),
				publicMsgID:this.publicMsgID,
				body:$("#editGlobalPublicMsgUI_body").val(),
			},
			function(json)
			{
				if(json.result==1)//成功
				{
					$("#editGlobalPublicMsgUI").modal('close');
					myAlert("保存成功");
				}
			}
		);
	}
	
}